---
/**
 * Backlinks - shows pages that link to the current page
 */
---

<section class="aside-panel" id="backlinks" data-page-path={Astro.url.pathname}>
  <h2 class="aside-panel-title">Backlinks</h2>
  <div class="aside-panel-content">
    <p class="backlinks-status">Loading...</p>
    <ul class="aside-panel-list" data-style="inline" style="display: none;"></ul>
  </div>
</section>

<script>
  interface Backlink { path: string; title: string; }
  type BacklinksIndex = Record<string, Backlink[]>;

  let cache: BacklinksIndex | null = null;

  async function initBacklinks() {
    const section = document.getElementById('backlinks');
    if (!section) return;
    
    const path = (section.dataset.pagePath?.replace(/\/$/, '') || '/') || '/';
    const status = section.querySelector('.backlinks-status') as HTMLElement;
    const list = section.querySelector('.aside-panel-list') as HTMLElement;
    
    if (!cache) {
      cache = await fetch('/backlinks.json').then(r => r.json());
    }
    
    const backlinks = cache![path] || [];
    
    if (backlinks.length === 0) {
      status.textContent = 'No pages link here yet.';
    } else {
      status.style.display = 'none';
      list.innerHTML = backlinks.map(b => `<li><a href="${b.path}">${b.title}</a></li>`).join('');
      list.style.display = '';
    }
  }

  document.addEventListener('astro:page-load', initBacklinks);
  document.readyState === 'complete' ? initBacklinks() : document.addEventListener('DOMContentLoaded', initBacklinks);
</script>
