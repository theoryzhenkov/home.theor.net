---
import { marked } from 'marked';
import Head from '@components/Head.astro';
import Header from '@components/Header.astro';
import Metadata from '@components/Metadata.astro';
import TOC from '@components/TOC.astro';
import Backlinks from '@components/Backlinks.astro';
import Search from '@components/Search.astro';
import Breadcrumb from '@components/Breadcrumb.astro';
import type { PageInfo } from '@/lib/relations';

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  title: string;
  description?: string;
  created: Date;
  modified?: Date;
  headings: Heading[];
  breadcrumbs?: PageInfo[];
  currentSlug?: string;
}

const { title, description, created, modified, headings, breadcrumbs = [], currentSlug = '' } = Astro.props;

// Parse markdown for display, strip for meta tags
const descriptionHtml = description ? marked.parseInline(description) : undefined;
const descriptionPlain = description?.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
---

<!DOCTYPE html>
<html lang="en">
  <Head title={title} description={descriptionPlain} />
  
  <body>
    <Header />
    
    <div class="page-grid">
      <aside class="page-sidebar page-sidebar--left">
        <TOC headings={headings} />
      </aside>
      
      <main class="page-main">
        <article class="article">
          <header class="article-header">
            <Breadcrumb breadcrumbs={breadcrumbs} currentSlug={currentSlug} />
            <h1 class="article-title">{title}</h1>
            {descriptionHtml && <p class="article-description" set:html={descriptionHtml} />}
            <Metadata 
              created={created}
              modified={modified}
            />
          </header>
          
          <div class="article-body">
            <slot />
          </div>
          
          <!-- Footnotes section (populated on small screens via JS) -->
          <section class="footnotes-section" data-footnotes="empty" aria-label="Footnotes">
            <h2 class="footnotes-title">Footnotes</h2>
            <ol class="footnotes-list"></ol>
          </section>
          
          <footer class="article-footer">
            <Backlinks />
          </footer>
        </article>
      </main>
      
      <aside class="page-sidebar page-sidebar--right">
        <!-- Reserved for margin content floats -->
      </aside>
    </div>
    
    <!-- Search Modal -->
    <Search />
    
    <!-- Popup Container -->
    <div id="popup-container" class="popup-container"></div>
    
    <!-- Scripts -->
    <script>
      import '@/scripts/popups';

      // Trigger highlight animation on a heading
      function highlightHeading(id: string) {
        const heading = document.getElementById(id);
        if (!heading?.matches('h1, h2, h3, h4, h5, h6')) return;
        
        heading.classList.remove('target-highlight');
        void heading.offsetWidth; // Force reflow
        heading.classList.add('target-highlight');
      }

      // Highlight on hash change
      function onHashChange() {
        const hash = window.location.hash.slice(1);
        if (hash) highlightHeading(hash);
      }

      // Heading anchor links
      function initHeadingLinks() {
        const headings = document.querySelectorAll('.article-body h1[id], .article-body h2[id], .article-body h3[id], .article-body h4[id], .article-body h5[id], .article-body h6[id]');
        
        const linkIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>`;
        
        headings.forEach((el) => {
          const heading = el as HTMLElement;
          // Skip if already initialized
          if (heading.querySelector('.heading-link-icon')) return;
          
          // Create link icon
          const icon = document.createElement('span');
          icon.className = 'heading-link-icon';
          icon.innerHTML = linkIconSvg;
          icon.title = `Copy link to "${heading.textContent}"`;
          heading.appendChild(icon);
          
          // Clicking heading navigates to anchor
          heading.style.cursor = 'pointer';
          heading.addEventListener('click', (e) => {
            if (e.target === icon || icon.contains(e.target as Node)) return;
            if (window.location.hash === `#${heading.id}`) {
              // Already at this hash, just highlight
              highlightHeading(heading.id);
              heading.scrollIntoView({ behavior: 'smooth' });
            } else {
              window.location.hash = heading.id;
            }
          });
          
          // Clicking icon copies link
          icon.addEventListener('click', async (e) => {
            e.stopPropagation();
            const url = `${window.location.origin}${window.location.pathname}#${heading.id}`;
            
            try {
              await navigator.clipboard.writeText(url);
              icon.classList.add('copying');
              setTimeout(() => icon.classList.remove('copying'), 500);
            } catch {
              window.location.hash = heading.id;
            }
          });
        });
      }

      // Handle clicks on anchor links when already at that hash
      function initAnchorHighlight() {
        document.addEventListener('click', (e) => {
          const link = (e.target as HTMLElement).closest('a[href^="#"]');
          if (!link) return;
          
          const targetId = link.getAttribute('href')?.slice(1);
          if (!targetId) return;
          
          if (window.location.hash === `#${targetId}`) {
            e.preventDefault();
            highlightHeading(targetId);
            document.getElementById(targetId)?.scrollIntoView({ behavior: 'smooth' });
          }
        });
      }

      // Initialize
      window.addEventListener('hashchange', onHashChange);
      initAnchorHighlight();
      
      // Highlight if page loads with hash
      if (window.location.hash) {
        onHashChange();
      }

      document.addEventListener('astro:page-load', initHeadingLinks);
      if (document.readyState === 'complete') {
        initHeadingLinks();
      } else {
        document.addEventListener('DOMContentLoaded', initHeadingLinks);
      }

      // ─── Margin Notes System ───
      // On large screens: margin notes float in the right margin
      // On small screens: margin notes move to footnotes section at bottom
      
      const MARGIN_BREAKPOINT = 1280;
      
      interface MarginNoteData {
        element: HTMLElement;
        placeholder: Comment;
        wrapper: HTMLElement;
        id: string;
      }
      
      let marginNotes: MarginNoteData[] = [];
      let isSmallScreen = false;
      
      function initMarginNotes() {
        const footnotesSection = document.querySelector('.footnotes-section');
        const footnotesList = document.querySelector('.footnotes-list') as HTMLOListElement | null;
        if (!footnotesSection || !footnotesList) return;
        
        // Collect all margin notes
        const marginContentElements = document.querySelectorAll('.margin-content');
        if (marginContentElements.length === 0) {
          footnotesSection.setAttribute('data-footnotes', 'empty');
          return;
        }
        
        // Build margin notes data
        marginNotes = [];
        marginContentElements.forEach((el) => {
          const element = el as HTMLElement;
          const wrapper = element.closest('.sidenote-wrapper') as HTMLElement;
          const id = element.id; // e.g., "fn-my-note"
          
          // Create a placeholder comment to mark original position
          const placeholder = document.createComment(`margin-note-placeholder:${id}`);
          
          marginNotes.push({ element, placeholder, wrapper, id });
        });
        
        footnotesSection.setAttribute('data-footnotes', 'ready');
        
        // Initial layout based on screen size
        handleResize();
      }
      
      function moveToBottom() {
        const footnotesList = document.querySelector('.footnotes-list') as HTMLOListElement | null;
        if (!footnotesList) return;
        
        // Clear existing list items
        footnotesList.innerHTML = '';
        
        marginNotes.forEach((note, index) => {
          // Insert placeholder where content was
          if (!note.element.parentNode?.contains(note.placeholder)) {
            note.element.parentNode?.insertBefore(note.placeholder, note.element);
          }
          
          // Create list item wrapper
          const li = document.createElement('li');
          li.className = 'footnote-item';
          li.id = `footnote-list-${index + 1}`;
          
          // Move the actual element into the list
          li.appendChild(note.element);
          footnotesList.appendChild(li);
        });
      }
      
      function moveToMargin() {
        marginNotes.forEach((note) => {
          // Find the placeholder and replace it with the element
          const placeholder = note.placeholder;
          if (placeholder.parentNode) {
            placeholder.parentNode.replaceChild(note.element, placeholder);
          } else if (note.wrapper) {
            // Fallback: append to wrapper
            note.wrapper.appendChild(note.element);
          }
        });
        
        // Clear the footnotes list
        const footnotesList = document.querySelector('.footnotes-list');
        if (footnotesList) {
          footnotesList.innerHTML = '';
        }
      }
      
      function handleResize() {
        const wasSmallScreen = isSmallScreen;
        isSmallScreen = window.innerWidth <= MARGIN_BREAKPOINT;
        
        // Only act if screen size category changed
        if (wasSmallScreen !== isSmallScreen || marginNotes.length === 0) {
          if (isSmallScreen) {
            moveToBottom();
          } else {
            moveToMargin();
          }
        }
      }
      
      // Debounce resize handler
      let resizeTimeout: ReturnType<typeof setTimeout> | null = null;
      function onResize() {
        if (resizeTimeout) clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(handleResize, 100);
      }
      
      // ─── Click Handler for Margin Note Links ───
      // On large screens: scroll to margin note + highlight
      // On small screens: let native anchor navigation happen
      
      function highlightElement(el: HTMLElement) {
        el.classList.remove('margin-highlight');
        void el.offsetWidth; // Force reflow
        el.classList.add('margin-highlight');
      }
      
      function handleMarginNoteClick(e: MouseEvent) {
        const link = (e.target as HTMLElement).closest('a.margin-number');
        if (!link) return;
        
        const href = link.getAttribute('href');
        if (!href?.startsWith('#fn-')) return;
        
        const targetId = href.slice(1);
        const targetElement = document.getElementById(targetId);
        if (!targetElement) return;
        
        // On small screens, let native anchor navigation work
        if (window.innerWidth <= MARGIN_BREAKPOINT) {
          // Content is in footnotes section - native scroll will work
          return;
        }
        
        // On large screens, scroll to margin note and highlight
        e.preventDefault();
        
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Highlight after scroll completes
        setTimeout(() => highlightElement(targetElement), 300);
      }
      
      // Initialize
      window.addEventListener('resize', onResize);
      document.addEventListener('click', handleMarginNoteClick);
      document.addEventListener('astro:page-load', () => {
        marginNotes = [];
        isSmallScreen = window.innerWidth <= MARGIN_BREAKPOINT;
        initMarginNotes();
      });
      if (document.readyState === 'complete') {
        initMarginNotes();
      } else {
        document.addEventListener('DOMContentLoaded', initMarginNotes);
      }
    </script>
  </body>
</html>

<style is:global>
  /* ─── Page Grid Layout ─── */
  .page-grid {
    display: grid;
    grid-template-columns: 1fr minmax(0, var(--width-content)) 1fr;
    max-width: var(--width-page-max);
    margin: 0 auto;
    padding: 0 var(--sp-8);
  }

  /* ─── Sidebars ─── */
  .page-sidebar {
    padding-top: var(--sp-8);
  }

  .page-sidebar--left {
    padding-right: var(--sp-8);
  }

  /* TOC sticky positioning - direct child selector for specificity */
  .page-sidebar--left > * {
    position: sticky;
    top: calc(var(--height-header) + var(--sp-8));
    width: var(--width-sidebar);
    max-height: calc(100vh - var(--height-header) - var(--sp-16));
    overflow-y: auto;
    margin-left: auto; /* Right-align within the column */
  }

  .page-sidebar--right {
    padding-left: var(--sp-4);
    padding-right: var(--sp-8);
  }

  /* ─── Main Content ─── */
  .page-main {
    min-width: 0;
    padding: var(--sp-8) 0;
  }

  /* ─── Article ─── */
  .article {
    /* Width controlled by grid column */
  }

  .article-header {
    margin-bottom: var(--sp-8);
  }

  .article-title {
    margin-bottom: var(--sp-3);
  }

  .article-description {
    font-size: var(--text-lg);
    color: var(--color-text-muted);
    font-style: italic;
    margin-bottom: var(--sp-6);
  }

  .article-body {
    /* Prose styles from global.css base layer */
  }

  .article-footer {
    margin-top: var(--sp-16);
    padding-top: var(--sp-8);
    border-top: 1px solid var(--color-border-subtle);
  }

  /* ─── Footnotes Section ─── */
  /* Hidden by default, shown on small screens when populated */
  .footnotes-section {
    display: none;
    margin-top: var(--sp-12);
    padding-top: var(--sp-6);
    border-top: 1px solid var(--color-border-subtle);
  }

  @media (max-width: 1280px) {
    .footnotes-section[data-footnotes="ready"] {
      display: block;
    }
  }

  .footnotes-title {
    font-size: var(--text-sm);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-subtle);
    margin-bottom: var(--sp-4);
    border-bottom: none;
    padding-bottom: 0;
  }

  .footnotes-list {
    list-style: decimal;
    padding-left: var(--sp-6);
    margin: 0;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    line-height: var(--leading-relaxed);
  }

  .footnotes-list li {
    margin-bottom: var(--sp-3);
    padding: var(--sp-2) 0;
  }

  .footnotes-list li::marker {
    color: var(--color-accent);
    font-weight: 500;
  }

  /* ─── Popup Container ─── */
  .popup-container {
    position: fixed;
    z-index: 150;
    pointer-events: none;
  }

  /* ─── Responsive Breakpoints ─── */
  @media (max-width: 1280px) {
    .page-grid {
      grid-template-columns: var(--width-sidebar) minmax(0, var(--width-content)) 1fr;
    }

    .page-sidebar--left {
      padding-right: var(--sp-6);
    }

    .page-sidebar--left > * {
      margin-left: 0; /* Left-align on medium screens */
    }

    .page-sidebar--right {
      display: none;
    }
  }

  @media (max-width: 1024px) {
    .page-grid {
      grid-template-columns: 1fr;
      padding: 0 var(--sp-6);
    }

    .page-sidebar--left {
      display: none;
    }
  }

  @media (max-width: 640px) {
    .page-grid {
      padding: 0 var(--sp-4);
    }
  }
</style>
