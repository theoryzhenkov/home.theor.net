---
import { marked } from 'marked';
import Head from '@components/Head.astro';
import Header from '@components/Header.astro';
import Metadata from '@components/Metadata.astro';
import TOC from '@components/TOC.astro';
import Footnotes from '@components/Footnotes.astro';
import Backlinks from '@components/Backlinks.astro';
import Search from '@components/Search.astro';
import Breadcrumb from '@components/Breadcrumb.astro';
import type { PageInfo } from '@/lib/relations';

interface Props {
  title: string;
  description?: string;
  created: Date;
  modified?: Date;
  headings: { depth: number; slug: string; text: string }[];
  breadcrumbs?: PageInfo[];
  currentSlug?: string;
}

const { title, description, created, modified, headings, breadcrumbs = [], currentSlug = '' } = Astro.props;
const descriptionHtml = description ? marked.parseInline(description) : undefined;
const descriptionPlain = description?.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
---

<!DOCTYPE html>
<html lang="en">
  <Head title={title} description={descriptionPlain} />
  
  <body>
    <Header />
    
    <div class="page-grid">
      <aside class="aside-margin">
        <TOC headings={headings} />
      </aside>

      <main class="min-w-0 py-4">
        <article>
          <header class="mb-4">
            <Breadcrumb breadcrumbs={breadcrumbs} currentSlug={currentSlug} />
            <h1>{title}</h1>
            {descriptionHtml && <p class="text-text-muted italic mb-2" set:html={descriptionHtml} />}
            <Metadata created={created} modified={modified} />
          </header>

          <div class="prose">
            <slot />
          </div>

          <footer class="page-footer">
            <Footnotes />
            <Backlinks />
          </footer>
        </article>
      </main>
    </div>
    
    <Search />
    <div id="popup-container" class="popup-container"></div>
    
    <script>
      import '@/scripts/popups';
      import '@/scripts/footnotes';

      function initHeadingLinks() {
        const headings = document.querySelectorAll('.prose h1[id], .prose h2[id], .prose h3[id], .prose h4[id], .prose h5[id], .prose h6[id]');
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>`;
        
        headings.forEach((el) => {
          const h = el as HTMLElement;
          if (h.querySelector('.heading-link-icon')) return;
          
          const icon = document.createElement('span');
          icon.className = 'heading-link-icon';
          icon.innerHTML = svg;
          h.appendChild(icon);
          
          h.style.cursor = 'pointer';
          h.addEventListener('click', (e) => {
            if (e.target === icon || icon.contains(e.target as Node)) return;
            window.location.hash = h.id;
          });
          
          icon.addEventListener('click', async (e) => {
            e.stopPropagation();
            try {
              await navigator.clipboard.writeText(`${location.origin}${location.pathname}#${h.id}`);
            } catch { window.location.hash = h.id; }
          });
        });
      }
      
      document.addEventListener('astro:page-load', initHeadingLinks);
      document.readyState === 'complete' ? initHeadingLinks() : document.addEventListener('DOMContentLoaded', initHeadingLinks);
    </script>
  </body>
</html>
