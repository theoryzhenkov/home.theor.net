@layer components {
  .page-grid {
    display: grid;
    grid-template-columns: 1fr minmax(0, var(--width-content)) 1fr;
    max-width: var(--width-page);
    margin-inline: auto;
    padding-inline: theme(spacing.4);

    @media (width <= 1024px) {
      grid-template-columns: 1fr;
      padding-inline: theme(spacing.3);
    }

    @media (width <= 640px) {
      padding-inline: theme(spacing.2);
    }
  }

  /* ─── Aside Margin (TOC sidebar on wide, inline on narrow) ─── */
  .aside-margin {
    padding-inline-end: theme(spacing.12);

    & > * {
      position: sticky;
      top: calc(var(--height-header) + theme(spacing.4));
      width: var(--width-sidebar);
      max-height: calc(100vh - var(--height-header) - theme(spacing.8));
      overflow-y: auto;
      margin-left: auto;
    }

    @media (width <= 1024px) {
      padding: theme(spacing.2) theme(spacing.3);

      & > * {
        position: static;
        width: auto;
        max-height: none;
        margin-left: 0;
      }
    }
  }

  /* ─── Page Footer ─── */
  .page-footer {
    margin-top: theme(spacing.6);
    padding-top: theme(spacing.4);
    border-top: 1px solid var(--color-border);
  }

  /* ─── Aside Panel (shared by Footnotes, Relations, TOC) ─── */
  .aside-panel {
    margin-bottom: theme(spacing.4);

    &:last-child {
      margin-bottom: 0;
    }

    &[data-empty="true"] {
      display: none;
    }
  }

  .aside-panel-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--color-text-muted);
    margin-bottom: theme(spacing.2);
  }

  .aside-panel-content {
    color: var(--color-text-muted);
  }

  .aside-panel-list {
    list-style: none;
    padding: 0;
    margin: 0;

    & li {
      margin-bottom: theme(spacing.1);
    }

    & a {
      color: var(--color-link);
      text-decoration: underline;
    }

    &[data-style="decimal"] {
      list-style: decimal;
      padding-left: theme(spacing.5);
    }

    &[data-style="inline"] {
      display: flex;
      flex-wrap: wrap;
      gap: theme(spacing.2);

      & li {
        margin-bottom: 0;
      }
    }
  }

  .popup-container {
    position: fixed;
    z-index: 150;
    pointer-events: none;
  }

  .link-popup {
    position: absolute;
    z-index: 1000;
    display: none;
    max-width: 300px;
    padding: theme(spacing.2);
    background-color: var(--color-bg);
    border: 1px solid var(--color-border);
    font-size: 0.875rem;
    pointer-events: auto;
    opacity: 0;
    transition: opacity var(--transition-duration-fast) var(--ease-out);

    &.visible {
      opacity: 1;
    }
  }

  .link-popup-title {
    margin: 0 0 theme(spacing.1);
    font-weight: 700;
    color: var(--color-text);
  }

  .link-popup-description {
    margin: 0 0 theme(spacing.1);
    color: var(--color-text-muted);
  }

  .link-popup-meta {
    display: flex;
    flex-wrap: wrap;
    gap: theme(spacing.2);
    font-size: 0.75rem;
  }

  .link-popup-status {
    color: var(--color-text-subtle);

    &[data-status="finished"] {
      color: var(--color-success);
    }

    &[data-status="in-progress"] {
      color: var(--color-warning);
    }
  }

  .link-popup-tags {
    color: var(--color-text-subtle);
    font-family: var(--font-mono);
  }

  .footnote-ref {
    counter-increment: sidenote-counter;
    line-height: 0;
  }

  .footnote-number {
    color: var(--color-accent);
    text-decoration: none;
    cursor: pointer;
    vertical-align: super;
    font-size: 0.85em;

    &::after {
      content: "[" counter(sidenote-counter) "]";
    }

    &:hover {
      color: var(--color-accent-hover);
    }
  }

  /* ─── Sidenotes (wide: absolute in right margin, narrow: hidden) ─── */
  .sidenote {
    position: absolute;
    left: calc(100% + 3rem);
    width: var(--width-sidenote, 14rem);
    font-size: 0.8rem;
    color: var(--color-text-muted);
    border-left: 1px solid var(--color-border);
    padding-left: theme(spacing.2);

    &[data-hidden] {
      display: none;
    }

    &.sidenote-highlight {
      background-color: var(--color-highlight-subtle, var(--color-bg-subtle));
      transition: background-color 0.3s ease-out;
    }

    @media (width <= 1024px) {
      display: none;
    }
  }

  /* ─── Mobile footnote list (matches sidenote styling) ─── */
  .footnote-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .footnote-item {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    border-left: 1px solid var(--color-border);
    padding-left: theme(spacing.2);
    margin-bottom: theme(spacing.2);

    &:last-child {
      margin-bottom: 0;
    }
  }

  [data-callout] {
    margin: theme(spacing.3) 0;
    padding: 0;
    border-left: 3px solid var(--color-border);
    background-color: var(--color-bg-subtle);
  }

  [data-callout-title] {
    padding: theme(spacing.1) theme(spacing.2);
    font-weight: 700;
    font-size: 0.875rem;
    border-bottom: 1px solid var(--color-border-subtle);
  }

  [data-callout-body] {
    padding: theme(spacing.2);

    & > *:last-child {
      margin-bottom: 0;
    }
  }

  [data-callout-type="note"],
  [data-callout-type="info"] {
    border-left-color: var(--color-accent);
  }

  [data-callout-type="tip"],
  [data-callout-type="hint"],
  [data-callout-type="important"] {
    border-left-color: var(--color-success);
  }

  [data-callout-type="warning"],
  [data-callout-type="caution"],
  [data-callout-type="attention"] {
    border-left-color: var(--color-warning);
  }

  [data-callout-type="danger"],
  [data-callout-type="error"],
  [data-callout-type="bug"] {
    border-left-color: var(--color-error);
  }

  [data-callout-type="quote"],
  [data-callout-type="cite"] {
    background-color: transparent;
    font-style: italic;
  }
}
